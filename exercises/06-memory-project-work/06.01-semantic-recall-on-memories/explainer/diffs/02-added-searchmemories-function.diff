commit 6fe315906ee90b113034187556fbb7e2f759a7cc
Author: Matt Pocock <team@aihero.dev>
Date:   Wed Nov 5 16:02:12 2025 +0000

    06.01.02 Added searchMemories function

diff --git a/src/app/memory-search.ts b/src/app/memory-search.ts
new file mode 100644
index 0000000..a44fd8d
--- /dev/null
+++ b/src/app/memory-search.ts
@@ -0,0 +1,21 @@
+import { DB, loadMemories } from "@/lib/persistence-layer";
+import { MyMessage } from "./api/chat/route";
+import { searchWithEmbeddings } from "./search";
+import { messageHistoryToQuery } from "./utils";
+
+export const memoryToText = (memory: DB.Memory) =>
+  `${memory.title}: ${memory.content}`;
+
+export const searchMemories = async (opts: { messages: MyMessage[] }) => {
+  const memories = await loadMemories();
+
+  const query = messageHistoryToQuery(opts.messages);
+
+  const embeddingsRanking = await searchWithEmbeddings(
+    query,
+    memories,
+    memoryToText
+  );
+
+  return embeddingsRanking;
+};
diff --git a/src/app/utils.ts b/src/app/utils.ts
new file mode 100644
index 0000000..4c532aa
--- /dev/null
+++ b/src/app/utils.ts
@@ -0,0 +1,31 @@
+import { MyMessage } from "./api/chat/route";
+
+export const messagePartsToText = (parts: MyMessage["parts"]) => {
+  return parts
+    .map((part) => {
+      if (part.type === "text") {
+        return part.text;
+      }
+    })
+    .filter((s) => typeof s === "string")
+    .join("\n");
+};
+
+export const messageToText = (message: MyMessage) => {
+  return `${message.role}: ${messagePartsToText(message.parts)}`;
+};
+
+/**
+ * Takes the message history and returns a query that can be
+ * used as a semantic search query.
+ *
+ * Includes the most recent message _twice_ to overweight
+ * it in the search results.
+ */
+export const messageHistoryToQuery = (messages: MyMessage[]) => {
+  const mostRecentMessage = messages[messages.length - 1];
+
+  const query = [...messages, mostRecentMessage].map(messageToText).join("\n");
+
+  return query;
+};
