commit 78aacfd565b3d1b2b95f2a906656a5861ab59b71
Author: Matt Pocock <team@aihero.dev>
Date:   Tue Nov 4 14:49:59 2025 +0000

    04.01.02 Added text splitter

diff --git a/package.json b/package.json
index f99d0be..4a9eaaf 100644
--- a/package.json
+++ b/package.json
@@ -1,60 +1,61 @@
 {
   "name": "ai-personal-assistant",
   "version": "0.1.0",
   "private": true,
   "scripts": {
     "dev": "next dev --turbopack",
     "build": "next build --turbopack",
     "start": "next start",
     "cherry-pick": "ai-hero-cli cherry-pick --branch=live-run-through",
     "reset": "ai-hero-cli reset --branch=live-run-through"
   },
   "dependencies": {
     "@ai-sdk/anthropic": "^2.0.44",
     "@ai-sdk/google": "^2.0.31",
     "@ai-sdk/react": "^2.0.93",
+    "@langchain/textsplitters": "^1.0.0",
     "@radix-ui/react-avatar": "^1.1.10",
     "@radix-ui/react-collapsible": "^1.1.12",
     "@radix-ui/react-dialog": "^1.1.15",
     "@radix-ui/react-dropdown-menu": "^2.1.16",
     "@radix-ui/react-hover-card": "^1.1.15",
     "@radix-ui/react-progress": "^1.1.7",
     "@radix-ui/react-scroll-area": "^1.2.10",
     "@radix-ui/react-select": "^2.2.6",
     "@radix-ui/react-separator": "^1.1.7",
     "@radix-ui/react-slot": "^1.2.3",
     "@radix-ui/react-tooltip": "^1.2.8",
     "@radix-ui/react-use-controllable-state": "^1.2.2",
     "ai": "^5.0.93",
     "class-variance-authority": "^0.7.1",
     "clsx": "^2.1.1",
     "embla-carousel-react": "^8.6.0",
     "lucide-react": "^0.544.0",
     "nanoid": "^5.1.6",
     "next": "15.5.4",
     "next-themes": "^0.4.6",
     "okapibm25": "^1.4.1",
     "react": "19.1.0",
     "react-dom": "19.1.0",
     "react-syntax-highlighter": "^15.6.6",
     "streamdown": "^1.3.0",
     "tailwind-merge": "^3.3.1",
     "tokenlens": "^1.3.1",
     "use-stick-to-bottom": "^1.1.1",
     "vite-tsconfig-paths": "^5.1.4",
     "zod": "^4.1.11"
   },
   "devDependencies": {
     "@tailwindcss/postcss": "^4.1.14",
     "@types/node": "^20",
     "@types/react": "^19",
     "@types/react-dom": "^19",
     "@types/react-syntax-highlighter": "^15.5.13",
     "ai-hero-cli": "^0.2.6",
     "evalite": "1.0.0-beta.4",
     "tailwindcss": "^4",
     "tw-animate-css": "^1.4.0",
     "typescript": "^5",
     "vitest": "^4.0.9"
   }
 }
diff --git a/src/app/search.ts b/src/app/search.ts
index e6f5ca5..685b1d2 100644
--- a/src/app/search.ts
+++ b/src/app/search.ts
@@ -6,8 +6,9 @@ import { google } from "@ai-sdk/google";
 import {
   ensureEmbeddingsCacheDirectory,
   getCachedEmbedding,
   writeEmbeddingToCache,
 } from "./embeddings";
+import { RecursiveCharacterTextSplitter } from "@langchain/textsplitters";
 
 export interface Email {
   id: string;
@@ -25,6 +26,44 @@ export interface Email {
   phaseId?: number;
 }
 
+export type EmailChunk = {
+  id: string;
+  subject: string;
+  chunk: string;
+  index: number;
+  totalChunks: number;
+  from: string;
+  to: string | string[];
+  timestamp: string;
+};
+
+const textSplitter = new RecursiveCharacterTextSplitter({
+  chunkSize: 1000,
+  chunkOverlap: 100,
+  separators: ["\n\n", "\n", " ", ""],
+});
+
+export const chunkEmails = async (emails: Email[]) => {
+  const emailsWithChunks: EmailChunk[] = [];
+  for (const email of emails) {
+    const chunks = await textSplitter.splitText(email.body);
+
+    chunks.forEach((chunk, chunkIndex) => {
+      emailsWithChunks.push({
+        id: email.id,
+        index: chunkIndex,
+        subject: email.subject,
+        chunk,
+        from: email.from,
+        to: email.to,
+        timestamp: email.timestamp,
+        totalChunks: chunks.length,
+      });
+    });
+  }
+  return emailsWithChunks;
+};
+
 export async function searchWithBM25(keywords: string[], emails: Email[]) {
   // Combine subject + body for richer text corpus
   const corpus = emails.map((email) => emailToText(email));
